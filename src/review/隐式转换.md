---
nav:
  title: Review
  path: /review
---

## 隐式转换

### 1 数学运算符转换

  减、乘、除 只会进行`Number`类型转换

  加 遵循下面转换

### 2 三种隐式转换类型

  1、将值转为原始值，`ToPrimitive()`。

  2、将值转为数字，`ToNumber()`。

  3、将值转为字符串，`ToString()`。

#### 2.1 通过`ToPrimitive`将值转换为原始值 

ToPrimitive在引擎内部签名：

```
ToPrimitive(input, PreferredType?)
```
input是要转换的值，PreferredType是可选参数，可以是Number或String类型。
他只是一个转换标志，转化后的结果并不一定是这个参数所值的类型，但是转换结果一定是一个原始值（或者报错）。

##### 2.1.1 如果`PreferredType`被标记为`Number`，则会进行下面的操作流程来转换输入的值。

```
1、如果输入的值已经是一个原始值，则直接返回它
2、否则，如果输入的值是一个对象，则调用该对象的valueOf()方法，
   如果valueOf()方法的返回值是一个原始值，则返回这个原始值。
3、否则，调用这个对象的toString()方法，如果toString()方法返回的是一个原始值，则返回这个原始值。
4、否则，抛出TypeError异常。
```

##### 2.1.2 如果`PreferredType`被标记为`String`，则会进行下面的操作流程来转换输入的值。
```
1、如果输入的值已经是一个原始值，则直接返回它
2、否则，调用这个对象的toString()方法，如果toString()方法返回的是一个原始值，则返回这个原始值。
3、否则，如果输入的值是一个对象，则调用该对象的valueOf()方法，
   如果valueOf()方法的返回值是一个原始值，则返回这个原始值。
4、否则，抛出TypeError异常。
```
既然`PreferredType`是可选参数，那么如果没有这个参数时，怎么转换呢？`PreferredType`的值会按照这样的规则来自动设置：

```
1、该对象为Date类型，则PreferredType被设置为String
2、否则，PreferredType被设置为Number
```

##### 2.1.3 `valueOf`方法和`toString`方法解析

valueOf:

|对象|返回值|
|  ----  | ----  |
|Array | 返回数组对象本身。
|Boolean	| 布尔值。
|Date	| 存储的时间是从 1970 年 1 月 1 日午夜开始计的毫秒数 UTC。
|Function	| 函数本身。
|Number	| 数字值。
|Object	| 对象本身。这是默认情况。
|String	| 字符串值。
| 	|Math 和 Error 对象没有 valueOf 方法。

toString:

|对象	|返回值|
|  ----  | ----  |
|Array|	返回数组字符串，字符串以逗号隔开,如："1,2,3,4"，空数组为空字符串|
|Boolean|	布尔字符串，"false"和"true"|
|Date	|现在时间字符串，如："Thu Jul 25 2019 14:35:20 GMT+0800 (中国标准时间)"|
|Function|	函数本身字符串|
|Number|	数字字符串|
|Object|	"[object Object]"|
|String|	字符串值|

#### 2.2 通过ToNumber将值转换为数字

|对象	|返回值|
|  ----  | ----  |
|undefined| NaN|
|null| +0|
|布尔值|true转换1，false转换为+0|
|数字|无须转换|
|字符串|有字符串解析为数字，例如：‘324’转换为324，‘qwer’转换为NaN|
|对象(obj)|先进行 ToPrimitive(obj, Number)转换得到原始值，在进行ToNumber转换为数字|

#### 2.3 通过ToString将值转换为字符串

|对象	|返回值|
|  ----  | ----  |
|undefined|'undefined'|
|null|'null'|
|布尔值|转换为'true' 或 'false'|
|数字|数字转换字符串，比如：1.765转为'1.765'|
|字符串|无须转换|
|对象(obj)|先进行 ToPrimitive(obj, String)转换得到原始值，在进行ToString转换为字符串|

### 3、== 运算符隐式转换

== 运算符的规则规律性不是那么强，按照下面流程来执行,es5文档

```
比较运算 x==y, 其中 x 和 y 是值，返回 true 或者 false。这样的比较按如下方式进行：

1、若 Type(x) 与 Type(y) 相同， 则

    1* 若 Type(x) 为 Undefined， 返回 true。
    2* 若 Type(x) 为 Null， 返回 true。
    3* 若 Type(x) 为 Number， 则
  
        (1)、若 x 为 NaN， 返回 false。
        (2)、若 y 为 NaN， 返回 false。
        (3)、若 x 与 y 为相等数值， 返回 true。
        (4)、若 x 为 +0 且 y 为 −0， 返回 true。
        (5)、若 x 为 −0 且 y 为 +0， 返回 true。
        (6)、返回 false。
        
    4* 若 Type(x) 为 String, 则当 x 和 y 为完全相同的字符序列（长度相等且相同字符在相同位置）时返回 true。 否则， 返回 false。
    5* 若 Type(x) 为 Boolean, 当 x 和 y 为同为 true 或者同为 false 时返回 true。 否则， 返回 false。
    6*  当 x 和 y 为引用同一对象时返回 true。否则，返回 false。
  
2、若 x 为 null 且 y 为 undefined， 返回 true。
3、若 x 为 undefined 且 y 为 null， 返回 true。
4、若 Type(x) 为 Number 且 Type(y) 为 String，返回比较 x == ToNumber(y) 的结果。
5、若 Type(x) 为 String 且 Type(y) 为 Number，返回比较 ToNumber(x) == y 的结果。
6、若 Type(x) 为 Boolean， 返回比较 ToNumber(x) == y 的结果。
7、若 Type(y) 为 Boolean， 返回比较 x == ToNumber(y) 的结果。
8、若 Type(x) 为 String 或 Number，且 Type(y) 为 Object，返回比较 x == ToPrimitive(y) 的结果。
9、若 Type(x) 为 Object 且 Type(y) 为 String 或 Number， 返回比较 ToPrimitive(x) == y 的结果。
10、返回 false。
```
总结为一下五条规则：

规则 1：`NaN`和其他任何类型比较永远返回`false`（包括和他自己）。

```js
NaN == NaN // false
```

规则 2：`Boolean` 和其他任何类型比较，`Boolean` 首先被转换为 `Number` 类型。

```js
true == 1  // true 
true == '2'  // false, 先把 true 变成 1，而不是把 '2' 变成 true
true == ['1']  // true, 先把 true 变成 1， ['1']拆箱成 '1', 再参考规则3
true == ['2']  // false, 同上
undefined == false // false ，首先 false 变成 0，然后参考规则4
null == false // false，同上
```
规则 3：`String`和`Number`比较，先将`String`转换为`Number`类型。
```js
123 == '123' // true, '123' 会先变成 123
'' == 0 // true, '' 会首先变成 0
```

规则 4：`null == undefined`比较结果是`true`，除此之外，`null`、`undefined`和其他任何结果的比较值都为`false`。

```js
null == undefined // true
null == '' // false
null == 0 // false
null == false // false
undefined == '' // false
undefined == 0 // false
undefined == false // false
```

规则 5：原始类型和引用类型做比较时，引用类型会依照`ToPrimitive`规则转换为原始类型。

如果还是没法得到一个原始类型，就会抛出 `TypeError`。

```js
'[object Object]' == {} 
// true, 对象和字符串比较，对象通过 toString 得到一个基本类型值
'1,2,3' == [1, 2, 3] 
// true, 同上  [1, 2, 3]通过 toString 得到一个基本类型值
```


`PreferredType` 默认值原因：

从上面`valueOf`和`toString`两个函数对对象的转换可以看出为什么对于`ToPrimitive(input, PreferredType?)`，
`PreferredType`没有设定的时候，除了Date类型，PreferredType被设置为String，其它的会设置成Number。

因为`valueOf`函数会将`Number`、`String`、`Boolean`基础类型的对象类型值转换成 基础类型，`Date`类型转换为毫秒数，
其它的返回对象本身，而`toString`方法会将所有对象转换为字符串。显然对于大部分对象转换，`valueOf`转换更合理些，
因为并没有规定转换类型，应该尽可能保持原有值，而不应该想`toString`方法一样，一股脑将其转换为字符串。

所以对于没有指定`PreferredType`类型时，先进行`valueOf`方法转换更好，故将`PreferredType`设置为`Number`类型。

而对于`Date`类型，其进行`valueOf`转换为毫秒数的`number`类型。在进行隐式转换时，没有指定将其转换为`number`类型时，
将其转换为那么大的`number`类型的值显然没有多大意义。（不管是在+运算符还是==运算符）还不如转换为字符串格式的日期，
所以默认`Date`类型会优先进行`toString`转换。故有以上的规则：

`PreferredType`没有设置时，`Date`类型的对象，`PreferredType`默认设置为`String`，其他类型对象`PreferredType`默认设置为`Number`。
